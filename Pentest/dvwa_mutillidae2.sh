#!/bin/bash
DVWA() {
	cd /var/www/html
	git clone https://github.com/digininja/DVWA.git
	chmod -R 755 /var/www/html/DVWA
	echo "" && echo "========== DVWAdb =========="
	#edit DVWA config file with updated db, user,  password
	#create MySQL database, user, password, permissions
	mysql -u root -e "create database dvwadb;"
	mysql -u root -e "create user 'dvwauser'@'127.0.0.1' identified by 'password';"
	mysql -u root -e "grant all on dvwadb.* to 'dvwauser'@'127.0.0.1';"
	mysql -u root -e "flush privileges;"
	echo "" && echo "========== DVWA config =========="
	cp /var/www/html/DVWA/config/config.inc.php.dist /var/www/html/DVWA/config/config.inc.php
	sed -i "s/database' ] = 'dvwa/database' ] = 'dvwadb/g" /var/www/html/DVWA/config/config.inc.php
	sed -i "s/user' ]     = 'dvwa/user' ]     = 'dvwauser/g" /var/www/html/DVWA/config/config.inc.php
	sed -i "s/password' ] = 'p\@ssw0rd/password' ] = 'password/g" /var/www/html/DVWA/config/config.inc.php
}
MUTILLIDAE() {
	cd /var/www/html
	git clone https://github.com/webpwnized/mutillidae.git
	chmod -R 755 /var/www/html/mutillidae
	echo "" && echo "========== Mutillidaedb =========="
	#edit mutillidae config file with updated db, user,  password
	mysql -u root -e "create database mutillidaedb;"
	mysql -u root -e "create user 'mutilliuser'@'127.0.0.1' identified by 'password';"
	mysql -u root -e "grant all on mutillidaedb.* to 'mutilliuser'@'127.0.0.1';"
	mysql -u root -e "flush privileges;"
	echo "" && echo "========== Mutillidae config =========="
	cp /var/www/html/mutillidae/includes/database-config.inc /var/www/html/mutillidae/includes/database-config.inc.BAK
	sed -i "s/USERNAME', 'root/USERNAME', 'mutilliuser/g" /var/www/html/mutillidae/includes/database-config.inc
	sed -i "s/PASSWORD', 'mutillidae/PASSWORD', 'password/g" /var/www/html/mutillidae/includes/database-config.inc
	sed -i "s/NAME', 'mutillidae/NAME', 'mutillidaedb/g" /var/www/html/mutillidae/includes/database-config.inc
}
# Check which Linux distribution is running
if [ -f /etc/redhat-release ]; then
	echo -n "" && echo "========== YUM =========="
	yum -y install epel-release yum-utils
	yum -y install http://rpms.remirepo.net/enterprise/remi-release-7.rpm
	yum-config-manager --enable remi-php73
	yum -y install git wget httpd mariadb-libs mariadb-server php php-common php-cli php-gd php-curl php-mysqlnd
	systemctl start httpd mariadb
	systemctl enable httpd mariadb
	echo -n "" && echo "========== se =========="
	setsebool -P httpd_unified 1
	setsebool -P httpd_can_network_connect 1
	setsebool -P httpd_can_network_connect_db 1
	echo -n "" && echo "========== firewall =========="
	firewall-cmd --permanent --zone public --add-port 80/tcp
	firewall-cmd --permanent --zone public --add-port 443/tcp
	firewall-cmd --reload
	echo -n "" && echo "========== PHP config =========="
	echo -e '<?php\nphpinfo();\n?>' > /var/www/html/phpinfo.php
	sed -i "s/allow_url_include = Off/allow_url_include = On/g" /etc/php.ini
	DVWA
	MUTILLIDAE
	chown -R apache:apache /var/www/html
	systemctl restart mariadb httpd
elif [ -f /etc/debian_version ]; then
	echo "" && echo "========== APT =========="
	apt -y install git wget nano apache2 mariadb-server php php-mysqli php-gd libapache2-mod-php php-mysql php-curl php-mbstring php-xml
	systemctl enable mariadb apache2
	systemctl start mariadb apache2
	echo "" && echo "========== PHP config =========="
	echo -e '<?php\nphpinfo();\n?>' > /var/www/html/phpinfo.php
	sed -i "s/allow_url_include = Off/allow_url_include = On/g" /etc/php/*/apache2/php.ini
	DVWA
	MUTILLIDAE
	chown -R www-data:www-data /var/www/html/
	systemctl restart mariadb apache2
	exit
else
    echo "This script does not support your Linux distribution."
fi
