#!/bin/bash
#sudo apt -y install python3-impacket
set -euo pipefail # Exit on error, undefined variable, or pipe failure

# --- Control Variables ---
RUN_BASIC=true
RUN_FULL=true

# --- Argument Parsing (NEW SECTION) ---
if [[ $# -gt 0 ]]; then
    case "$1" in
        -basic)
            RUN_FULL=false
            echo "Running: Basic Audit Only"
            ;;
        -full)
            RUN_BASIC=false
            echo "Running: Full Audit Only"
            ;;
        *)
            echo "Usage: $0 [-basic | -full]"
            echo "No valid switch specified. Running both Basic and Full Audits."
            ;;
    esac
fi
echo ""
# --- Date Variable Setup ---
# Get the current date in YYYY.MM.DD format
CURRENT_DATE=$(date +%Y.%m.%d)

# --- NTDS variables
NTDS_LOCATION="ntds.dit"
SYSTEM_LOCATION="SYSTEM"

# --- Configuration Variables ---
HASH_MODE=1000
ALL_DOMAINS_FILE="1.Domain.ALL"
DOMAIN_USERS_FILE="2.Domain.Users"
ORIGINAL_BASIC_WORDLIST="0.1.Basic_Pass.lst" #Fill this list with your basic words (ex: winter, spring, summer, fall)
BASIC_WORDLIST="3.Basic_Pass.lst"
ORIGINAL_FULL_WORDLIST="0.2.rockyou.txt" #update to your rockyou.txt path
FULL_WORDLIST="3.rockyou.txt"

# Potfiles (Highly Sensitive!)
BASIC_POTFILE="4.Domain_Basic.potfile"
FULL_POTFILE="4.Domain_Full.potfile"

# Rule Files
RULE_EVERYTHING="/usr/share/hashcat/rules/0.Everything.rule"
#RULE_ONERULE="/usr/share/hashcat/rules/0.OneRuleToRuleThemStill.rule" #Uncomment and update to whatever second rule you desire

# Report Files
BASIC_RESULTS_FILE="5.Basic_Results.${CURRENT_DATE}.txt"
FULL_RESULTS_FILE="5.Full_Results.${CURRENT_DATE}.txt"
BASIC_CRACKED_PASS_FILE="4.Basic_cracked_pass.${CURRENT_DATE}.txt"
FULL_CRACKED_PASS_FILE="4.Full_cracked_pass.${CURRENT_DATE}.txt"

# --- File Pre-Check Section ---
echo "--- Performing File Integrity Check ---"
declare -a required_files=(
    "$NTDS_LOCATION"
    "$SYSTEM_LOCATION"
    "$ORIGINAL_BASIC_WORDLIST"
    "$ORIGINAL_FULL_WORDLIST"
    "$RULE_EVERYTHING"
    #"$RULE_ONERULE"
)

# Flag to track if any file is missing
missing_file_found=0

for file_path in "${required_files[@]}"; do
    if [[ ! -f "$file_path" ]]; then
        echo "❌ ERROR: Required file not found: $file_path" >&2
        missing_file_found=1
    else
        echo "✅ Found: $file_path"
    fi
done

if [[ "$missing_file_found" -eq 1 ]]; then
    echo "--- Audit halted. Please resolve the missing files and re-run. ---" >&2
    exit 1
fi
echo "--- All required files confirmed. Starting audit. ---"
echo ""

# --- 0. Remove the previous reports and artifcats ---
rm -rf *\.Basic_cracked_users\.*\.txt *\.Basic_cracked_pass\.*\.txt *\.Full_cracked_users\.*\.txt *\.Full_cracked_pass\.*\.txt *.potfile "$BASIC_POTFILE" "$FULL_POTFILE"

# --- 0. Export ntds users and hashes ---
echo "Exporting from NTDS.dit..."
#impacket-secretsdump -ntds $NTDS_LOCATION -system $SYSTEM_LOCATION LOCAL > "$ALL_DOMAINS_FILE"

# --- 1. Prepare Hash File ---
echo "Preparing domain user hash file..."
grep -v '\$' "$ALL_DOMAINS_FILE" | grep -E '.*\\.*:::$' > "$DOMAIN_USERS_FILE"

# -----------------------------------------------------------
# --- 2. Basic Password Cracking Loop (CONDITIONALLY RUN) ---
# -----------------------------------------------------------
if $RUN_BASIC; then
    echo "Starting Basic password audit..."
    set +e

    # --- Create temp Basic wordlist ---
    #hashcat -m $HASH_MODE -a 0 "$DOMAIN_USERS_FILE" "$ORIGINAL_BASIC_WORDLIST" -r "$RULE_ONERULE" --potfile-path="$BASIC_POTFILE"
    hashcat -m $HASH_MODE -a 0 "$DOMAIN_USERS_FILE" "$ORIGINAL_BASIC_WORDLIST" -r "$RULE_EVERYTHING" --potfile-path="$BASIC_POTFILE"
    cut -d ':' -f2 "$BASIC_POTFILE" | sort | uniq >> "$BASIC_WORDLIST"
    sort -u -o "$BASIC_WORDLIST" "$BASIC_WORDLIST"

    # --- Hashcat iterations with temp Basic wordlist ---
        for i in {1..5}; do
        hashcat -m $HASH_MODE -a 0 "$DOMAIN_USERS_FILE" "$BASIC_WORDLIST" -r "$RULE_EVERYTHING" --potfile-path="$BASIC_POTFILE"
        cut -d ':' -f2 "$BASIC_POTFILE" | sort | uniq >> "$BASIC_WORDLIST"
        sort -u -o "$BASIC_WORDLIST" "$BASIC_WORDLIST"
    done
    set -e

    # --- 3. Optimized Basic Reporting ---
    echo "Generating Basic audit report..."
    TMP_BASIC_SHOW="tmp_basic_show.txt"
    hashcat -m $HASH_MODE -a 0 "$DOMAIN_USERS_FILE" --potfile-path="$BASIC_POTFILE" --show --username > "$TMP_BASIC_SHOW" || true

    cut -d ':' -f3 "$TMP_BASIC_SHOW" | sort > "$BASIC_CRACKED_PASS_FILE"
    cp "$BASIC_CRACKED_PASS_FILE" "3.Basic_cracked_users.${CURRENT_DATE}.txt"

    echo "Affected user count: $(wc -l < "$TMP_BASIC_SHOW")" > "$BASIC_RESULTS_FILE"
    echo "Unique Password Count: $(sort -u "$BASIC_CRACKED_PASS_FILE" | wc -l)" >> "$BASIC_RESULTS_FILE"
    echo "Duplicate passwords over 2 count" >> "$BASIC_RESULTS_FILE"
    sort "$BASIC_CRACKED_PASS_FILE" | uniq -c | sort -rn | awk '$1 >= 2' >> "$BASIC_RESULTS_FILE"
    echo "" >> "$BASIC_RESULTS_FILE"
    echo "Password Lengths:" >> "$BASIC_RESULTS_FILE"
    awk 'length($1) > 0 {print length($1)}' "$BASIC_CRACKED_PASS_FILE" | sort -n | uniq -c | awk '{print $2 " characters : " $1}' >> "$BASIC_RESULTS_FILE"

    rm -f "$TMP_BASIC_SHOW"
    echo "Basic audit report complete."
fi

# ----------------------------------------------------------
# --- 4. Full Password Cracking Loops (CONDITIONALLY RUN) ---
# ----------------------------------------------------------
if $RUN_FULL; then
    echo "Starting Full password audit..."
    set +e
    # --- Create temp Full wordlist ---
    #hashcat -m $HASH_MODE -a 0 "$DOMAIN_USERS_FILE" "$ORIGINAL_FULL_WORDLIST" -r "$RULE_ONERULE" --potfile-path="$FULL_POTFILE"
    hashcat -m $HASH_MODE -a 0 "$DOMAIN_USERS_FILE" "$ORIGINAL_FULL_WORDLIST" -r "$RULE_EVERYTHING" --potfile-path="$FULL_POTFILE"
    cut -d ':' -f2 "$FULL_POTFILE" | sort | uniq >> "$FULL_WORDLIST"
    sort -u -o "$FULL_WORDLIST" "$FULL_WORDLIST"

    # --- Hashcat iterations with temp Full wordlist ---
    for i in {1..2}; do
        hashcat -m $HASH_MODE -a 0 "$DOMAIN_USERS_FILE" "$FULL_WORDLIST" -r "$RULE_EVERYTHING" --potfile-path="$FULL_POTFILE"
        cut -d ':' -f2 "$FULL_POTFILE" | sort | uniq >> "$FULL_WORDLIST"
        sort -u -o "$FULL_WORDLIST" "$FULL_WORDLIST"
    done
    
    #for i in {1..2}; do
        #hashcat -m $HASH_MODE -a 0 "$DOMAIN_USERS_FILE" "$FULL_WORDLIST" -r "$RULE_ONERULE" --potfile-path="$FULL_POTFILE"
        #cut -d ':' -f2 "$FULL_POTFILE" | sort | uniq >> "$FULL_WORDLIST"
        #sort -u -o "$FULL_WORDLIST" "$FULL_WORDLIST"
    #done
    set -e

    # --- 5. Optimized Full Reporting ---
    echo "Generating Full audit report..."
    TMP_FULL_SHOW="tmp_full_show.txt"
    hashcat -m $HASH_MODE -a 0 "$DOMAIN_USERS_FILE" --potfile-path="$FULL_POTFILE" --show --username > "$TMP_FULL_SHOW" || true

    cut -d ':' -f3 "$TMP_FULL_SHOW" | sort > "$FULL_CRACKED_PASS_FILE"
    cp "$FULL_CRACKED_PASS_FILE" "3.Full_cracked_users.${CURRENT_DATE}.txt"

    echo "Affected user count: $(wc -l < "$TMP_FULL_SHOW")" > "$FULL_RESULTS_FILE"
    echo "Unique Password Count: $(sort -u "$FULL_CRACKED_PASS_FILE" | wc -l)" >> "$FULL_RESULTS_FILE"
    echo "Duplicate passwords over 2 count" >> "$FULL_RESULTS_FILE"
    sort "$FULL_CRACKED_PASS_FILE" | uniq -c | sort -rn | awk '$1 >= 2' >> "$FULL_RESULTS_FILE"
    echo "" >> "$FULL_RESULTS_FILE"
    echo "Password Lengths:" >> "$FULL_RESULTS_FILE"
    awk 'length($1) > 0 {print length($1)}' "$FULL_CRACKED_PASS_FILE" | sort -n | uniq -c | awk '{print $2 " characters : " $1}' >> "$FULL_RESULTS_FILE"

    rm -f "$TMP_FULL_SHOW"
    echo "Full audit report complete."
fi

# --- 6. Final Cleanup ---
rm -f "$BASIC_POTFILE" "$FULL_POTFILE"
echo "Audit complete. Remember to securely delete $BASIC_POTFILE and $FULL_POTFILE!"
