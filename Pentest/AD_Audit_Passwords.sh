#!/bin/bash

# Function to detect OS distribution
detect_distro() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo "$ID"
    else
        echo "unknown"
    fi
}

# Detect the OS distribution
distro=$(detect_distro)

# Ask for user input
read -p "User (example: JohnSmith): " user
read -sp "Password for that user: " pass
echo
read -p "DC hostname/IP: " dc

# Hash the password into NTLM
HASH=$(echo -n "$pass" | iconv -f ASCII -t UTF-16LE | openssl dgst -md4 -provider legacy -provider default | awk '{print $2}')

# Enumerate accounts and passwords
echo ""
echo "==========================================="
echo "== exporting user+hashes, please wait... =="
echo "==========================================="

if [ "$distro" == "kali" ]; then
    # Command for Kali Linux
    impacket-secretsdump -just-dc "LAB/$user@$dc" -hashes "aad3b435b51404eeaad3b435b51404ee:$HASH" > domain_dump.txt
else
    # Command for other distributions
    secretsdump.py -just-dc "LAB/$user@$dc" -hashes "aad3b435b51404eeaad3b435b51404ee:$HASH" > domain_dump.txt
fi

# Cleanup only users and hashes, and crack them
grep ':::' domain_dump.txt | tee domain_clean.txt | \
    hashcat -m 1000 -a 0 - /usr/share/wordlists/rockyou.txt -o hits.txt

echo ""
echo "==================================================="
echo "== Cracking complete, please see Needs_Reset.txt =="
echo "==================================================="

# Enumerate users that need to reset their passwords
awk -F ':' '{print $1}' hits.txt | \
    while read i; do
        grep "$i" domain_clean.txt | cut -d ':' -f1 | cut -d '\' -f2
    done > Needs_Reset.txt

# Remove .potfile to ensure password confidentiality
> ~/.local/share/hashcat/hashcat.potfile
