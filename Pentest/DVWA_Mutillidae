#!/bin/sh
#check for package mangers
check_cmd() {
    command -v "$1" 2> /dev/null
}
update_apt() {
    if check_cmd apt-get; then
        echo "" && echo ========== APT ==========
        #Install proper packages
        apt -y install git wget nano apache2 mysql-server php php-mysqli php-gd libapache2-mod-php php-mysql php-curl php-mbstring php-xml
        echo "" && echo ========== PHPinfo ==========
        #test page to show php is installed properly
        echo -e '<?php\nphpinfo();\n?>' > /var/www/html/phpinfo.php
        echo "" && echo ========== Git ==========
        #download DVWA and Mutillidae
        cd /var/www/html
        git clone https://github.com/digininja/DVWA.git
        git clone https://github.com/webpwnized/mutillidae.git
        #========== Possible Snapshot Spot ==========
        echo "" && echo ========== CHMOD ==========
        #change folder permissions
        chmod -R 755 /var/www/html/DVWA
        chown -R www-data:www-data /var/www/html/DVWA
        chmod -R 755 /var/www/html/mutillidae && chown -R www-data:www-data /var/www/html/mutillidae
        chown -R www-data:www-data /var/www/html/mutillidae
        echo "" && echo ========== DVWA ==========
        #edit DVWA config file with updated db, user,  password
        cp /var/www/html/DVWA/config/config.inc.php.dist /var/www/html/DVWA/config/config.inc.php
        sed -i "s/database' ] = 'dvwa/database' ] = 'dvwadb/g" /var/www/html/DVWA/config/config.inc.php
        sed -i "s/user' ]     = 'dvwa/user' ]     = 'dvwauser/g" /var/www/html/DVWA/config/config.inc.php
        sed -i "s/password' ] = 'p\@ssw0rd/password' ] = 'password/g" /var/www/html/DVWA/config/config.inc.php
        echo "" && echo ========== Mutillidae ==========
        #edit mutillidae config file with updated db, user,  password
        cp /var/www/html/mutillidae/includes/database-config.inc /var/www/html/mutillidae/includes/database-config.inc.BAK
        sed -i "s/USERNAME', 'root/USERNAME', 'mutilliuser/g" /var/www/html/mutillidae/includes/database-config.inc
        sed -i "s/PASSWORD', 'mutillidae/PASSWORD', 'password/g" /var/www/html/mutillidae/includes/database-config.inc
        sed -i "s/NAME', 'mutillidae/NAME', 'mutillidaedb/g" /var/www/html/mutillidae/includes/database-config.inc
        echo "" && echo ========== MYSQL ==========
        #create MySQL database, user, password, permissions
        mysql -u root -e "create database dvwadb;"
        mysql -u root -e "create user 'dvwauser'@'127.0.0.1' identified by 'password';"
        mysql -u root -e "grant all on dvwadb.* to 'dvwauser'@'127.0.0.1';"
        mysql -u root -e "create database mutillidaedb;"
        mysql -u root -e "create user 'mutilliuser'@'127.0.0.1' identified by 'password';"
        mysql -u root -e "grant all on mutillidaedb.* to 'mutilliuser'@'127.0.0.1';"
        echo "" && echo ========== PHP ==========
        #change PHP permissions
        sed -i "s/allow_url_include = Off/allow_url_include = On/g" /etc/php/8.1/apache2/php.ini
        echo "" && echo ========== Restart ==========
        #restart services
        systemctl enable mysql apache2
        systemctl start mysql apache2
        systemctl restart mysql apache2
        exit
    fi
}
update_dnf() {
    if check_cmd dnf; then
        echo -n "" && echo "========== dnf =========="
        dnf -y install git wget apache2 php php-mysqli php-gd libapache2-mod-php mariadb mariadb-libs mariadb-server
        systemctl start httpd mariadb
        systemctl enable httpd mariadb
        echo -n "" && echo "========== se =========="
        setsebool -P httpd_unified 1
        setsebool -P httpd_can_network_connect 1
        setsebool -P httpd_can_network_connect_db 1
        echo -n "" && echo "========== firewall =========="
        firewall-cmd --permanent --zone public --add-port 80/tcp
        firewall-cmd --permanent --zone public --add-port 443/tcp
        firewall-cmd --reload
        echo -n "" && echo "========== phpinfo =========="
        echo -e '<?php\nphpinfo();\n?>' > /var/www/html/phpinfo.php
        #DVWA
        echo -n "" && echo "========== git =========="
        cd /var/www/html
        git clone https://github.com/digininja/DVWA.git
        #git clone https://github.com/webpwnized/mutillidae.git
        chown -R apache:apache /var/www/html
        chmod -R 755 /var/www/html/DVWA
        #chmod -R 755 /var/www/html/mutillidae
        cp /var/www/html/DVWA/config/config.inc.php.dist /var/www/html/DVWA/config/config.inc.php
        echo -n "" && echo "========== dvwa config =========="
        sed -i "s/database' ] = 'dvwa/database' ] = 'dvwadb/g" /var/www/html/DVWA/config/config.inc.php
        sed -i "s/user' ]     = 'dvwa/user' ]     = 'dvwauser/g" /var/www/html/DVWA/config/config.inc.php
        sed -i "s/password' ] = 'p\@ssw0rd/password' ] = 'password/g" /var/www/html/DVWA/config/config.inc.php
        #echo -n "" && echo "========== mutillidae config =========="
        #sed -i "s/NAME', 'mutillidae/NAME', 'mutillidaedb/g" /var/www/html/mutillidae/includes/database-config.inc
        #sed -i "s/USERNAME', 'root/USERNAME', 'mutilliuser/g" /var/www/html/mutillidae/includes/database-config.inc
        #sed -i "s/PASSWORD', 'mutillidae/PASSWORD', 'password/g" /var/www/html/mutillidae/includes/database-config.inc
        echo "" && echo "========== php =========="
        #change PHP permissions
        sed -i "s/allow_url_include = Off/allow_url_include = On/g" /etc/php.ini
        #SQL
        systemctl restart mariadb httpd
        echo -n "" && echo "========== dvwa db =========="
        mysql -u root -e "create database dvwadb;"
        mysql -u root -e "create user dvwauser@127.0.0.1 identified by 'password';"
        mysql -u root -e "grant all on dvwadb.* to dvwauser@127.0.0.1;"
        mysql -u root -e "flush privileges;"
        systemctl restart mariadb httpd
        #echo -n "" && echo "========== mutillidae db =========="
        #mysql -u root -e "create database mutillidaedb;"
        #mysql -u root -e "create user mutilliuser@127.0.0.1 identified by 'password';"
        #mysql -u root -e "grant all on mutillidaedb.* to mutilliuser@127.0.0.1;"
        #mysql -u root -e "flush privileges;"
        systemctl restart mariadb httpd
        exit
    fi
}
update_yum() {
    if check_cmd yum && check_cmd yum-config-manager; then
        echo -n "" && echo "========== yum =========="
        yum -y install git wget apache2 php php-mysqli php-gd libapache2-mod-php mariadb mariadb-libs mariadb-server
        systemctl start httpd mariadb
        systemctl enable httpd mariadb
        echo -n "" && echo "========== se =========="
        setsebool -P httpd_unified 1
        setsebool -P httpd_can_network_connect 1
        setsebool -P httpd_can_network_connect_db 1
        echo -n "" && echo "========== firewall =========="
        firewall-cmd --permanent --zone public --add-port 80/tcp
        firewall-cmd --permanent --zone public --add-port 443/tcp
        firewall-cmd --reload
        echo -n "" && echo "========== phpinfo =========="
        echo -e '<?php\nphpinfo();\n?>' > /var/www/html/phpinfo.php
        #DVWA
        echo -n "" && echo "========== git =========="
        cd /var/www/html
        git clone https://github.com/digininja/DVWA.git
        #git clone https://github.com/webpwnized/mutillidae.git
        chown -R apache:apache /var/www/html
        chmod -R 755 /var/www/html/DVWA
        #chmod -R 755 /var/www/html/mutillidae
        cp /var/www/html/DVWA/config/config.inc.php.dist /var/www/html/DVWA/config/config.inc.php
        echo -n "" && echo "========== dvwa config =========="
        sed -i "s/database' ] = 'dvwa/database' ] = 'dvwadb/g" /var/www/html/DVWA/config/config.inc.php
        sed -i "s/user' ]     = 'dvwa/user' ]     = 'dvwauser/g" /var/www/html/DVWA/config/config.inc.php
        sed -i "s/password' ] = 'p\@ssw0rd/password' ] = 'password/g" /var/www/html/DVWA/config/config.inc.php
        #echo -n "" && echo "========== mutillidae config =========="
        #sed -i "s/NAME', 'mutillidae/NAME', 'mutillidaedb/g" /var/www/html/mutillidae/includes/database-config.inc
        #sed -i "s/USERNAME', 'root/USERNAME', 'mutilliuser/g" /var/www/html/mutillidae/includes/database-config.inc
        #sed -i "s/PASSWORD', 'mutillidae/PASSWORD', 'password/g" /var/www/html/mutillidae/includes/database-config.inc
        echo "" && echo "========== php =========="
        #change PHP permissions
        sed -i "s/allow_url_include = Off/allow_url_include = On/g" /etc/php.ini
        #SQL
        systemctl restart mariadb httpd
        echo -n "" && echo "========== dvwa db =========="
        mysql -u root -e "create database dvwadb;"
        mysql -u root -e "create user dvwauser@127.0.0.1 identified by 'password';"
        mysql -u root -e "grant all on dvwadb.* to dvwauser@127.0.0.1;"
        mysql -u root -e "flush privileges;"
        systemctl restart mariadb httpd
        #echo -n "" && echo "========== mutillidae db =========="
        #mysql -u root -e "create database mutillidaedb;"
        #mysql -u root -e "create user mutilliuser@127.0.0.1 identified by 'password';"
        #mysql -u root -e "grant all on mutillidaedb.* to mutilliuser@127.0.0.1;"
        #mysql -u root -e "flush privileges;"
        systemctl restart mariadb httpd
        exit
    fi
}
update_apt; update_dnf; update_yum
# None of the known package managers (apt, yum, pacman, zypper) are available
echo "Error: Couldn't identify the package manager"
exit 1
