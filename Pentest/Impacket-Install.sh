#!/bin/bash

# Ensure the script is not run with sudo
if [ "$EUID" -eq 0 ]; then
  echo "Please do not run this script as root or with sudo."
  exit 1
fi

# Determine the package manager and OS type
if [ -f /etc/debian_version ]; then
  OS="Debian"
  PKG_MGR="apt"
  PKG_INSTALL="sudo $PKG_MGR -y install"
elif [ -f /etc/fedora-release ]; then
  OS="Fedora"
  PKG_MGR="dnf"
  PKG_INSTALL="sudo $PKG_MGR -y install"
elif [ -f /etc/arch-release ]; then
  OS="Arch"
  PKG_MGR="pacman"
  PKG_INSTALL="sudo $PKG_MGR -S --noconfirm"
else
  echo "Unsupported Linux distribution."
  exit 1
fi

# Check if Python 3 is installed
if ! command -v python3 &> /dev/null; then
  echo "Python 3 is not installed. Installing Python 3.10..."
  $PKG_INSTALL python3.10 python3-pip
else
  PYTHON_VERSION=$(python3 --version | cut -d ' ' -f 2)
  echo "Python 3 is installed. Version: $PYTHON_VERSION"

  # Check if Python version is 3.6, 3.7, 3.8, 3.9, or 3.10
  case "$PYTHON_VERSION" in
    3.6*|3.7*|3.8*|3.9*|3.10*)
      echo "Installing python${PYTHON_VERSION%.*}-venv..."
      $PKG_INSTALL python${PYTHON_VERSION%.*}-venv
      ;;
    *)
      echo "Unsupported Python version. Please use Python 3.6 to 3.10."
      exit 1
      ;;
  esac
fi

# Install pipx and impacket
echo "Installing pipx and impacket..."

# Different installation process for pipx depending on the OS
if [ "$OS" = "Debian" ]; then
  $PKG_INSTALL pipx
else
  $PKG_INSTALL pipx
  python3 -m pip install --user pipx
fi

python3 -m pipx install impacket
pipx ensurepath

echo "Installation complete."
